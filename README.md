# Online-Chat-Messenger

これは、TCPとUDPを使用してチャットルーム機能を提供するオンラインチャットシステムです。ユーザーはチャットルームを作成したり、既存のルームに参加したりして、リアルタイムでメッセージをやり取りすることができます。

## 概要

このシステムは、クライアントとサーバーの2つの主要なコンポーネントで構成されています。サーバーはチャットルームとユーザーを管理し、メッセージの中継を担当します。クライアントはユーザーインターフェースを提供し、サーバーとの通信を処理します。

通信は2つのフェーズに分かれています。

1.  **TCP通信**: ルームの作成や参加といった初期設定に使用されます。初期設定完了後、クライアントはサーバーからトークンを受け取ります。
2.  **UDP通信**: 実際にメッセージを送受信するのに使用されます。クライアントはUDPを使用してメッセージをサーバーに送信し、サーバーはそれをルーム内の他のクライアントに中継します。

## TCPプロトコル

TCP通信は、ルームの作成と参加のリクエスト・レスポンスに使用されます。

**ヘッダー**

* **RoomNameSize**: エンコード後のルーム名の長さ。(1バイト)
* **Operation**: 操作コードをエンコードしたもの。(1バイト)
* **State**: 状態コードをエンコードしたもの。(1バイト)
* **OperationPayloadSize**: エンコード後のオペレーションペイロードの長さ。(29バイト)

**ボディ**

* **RoomName**: ルーム名。(最大 2^8 バイト)
* **OperationPayload**: JSON形式のオペレーションペイロード。(最大 2^29 バイト)

### TCPデータ構造
```python
operation = "操作コード(1 or 2)"
state = "状態コード(0 ~ 2)"
room_name = "ルーム名"
operation_payload = {
     user_name = "ユーザー名"
     token = "トークン"
     password = "パスワード(平文)"
}
```

## UDPプロトコル

UDP通信は、チャットメッセージの送受信に使用されます。パケットの最大サイズは4096バイトです。

**ヘッダー**

* **RoomNameSize**: エンコード後のルーム名の長さ (1バイト)
* **UserNameSize**: エンコード後のユーザー名の長さ（1バイト）
* **TokenSize**: エンコード後のトークンの長さ (1バイト)

**ボディ**

**最大で合計4093バイト**
* **RoomName**: エンコードされたルーム名
* **UserName**: エンコードされたユーザー名
* **Token**: エンコードされたトークン
* **Message**: エンコードされたメッセージ

### UDPデータ構造
```Python
header = (
    # RoomNameSize + UserNameSize + TokenSize
    len(room_name_bytes).to_bytes(1, "big") +
    len(user_name_bytes).to_bytes(1, "big") +
    len(token_bytes).to_bytes(1, "big")
)
body = (
    # RoomName + UserName + Token + Message
    room_name_bytes +
    user_name_bytes +
    token_bytes +
    message_bytes
)
```

## データの保存先
* ```rooms_list```: ルームに関するデータを保持する辞書型のリスト。
```Python
rooms_list = {
    "ルーム名A": {
        "members": {
            "トークン1": ("クライアント1のIPアドレス", UDPポート番号),
            "トークン2": ("クライアント2のIPアドレス", UDPポート番号)
        },
        "password": "パスワード(平文)"
    },
    "ルーム名B": {
        "members": {
            "トークン3": ("クライアント3のIPアドレス", UDPポート番号),
            "トークン4": ("クライアント4のIPアドレス", UDPポート番号)
        },
        "password": "パスワード(平文)"
    }
}
```

* ```token_list```: トークンに関するデータを保持する辞書型のリスト。
```Python
token_list = {
    "トークン1": {
        "room_name": "ルーム名A",
        "user_name": "ユーザー名",
        "last_access": datetime.datetime.now(), # 最終メッセージ送信時刻
        "is_host": True  # ホスト
    },
    "トークン2": {
        "room_name": "ルーム名A",
        "user_name": "ユーザー名",
        "last_access": datetime.datetime.now(), # 最終メッセージ送信時刻
        "is_host": False # ホストではない
    },
    ...
}
```

## システムの流れ

### TCP通信

#### サーバー
1.  **サーバー起動**: `server.py` を実行すると、TCPサーバーとUDPサーバーが起動し、接続・受信待機状態になります。
2.  **TCPリクエスト受信・検証**: リクエストを受信・検証して、成功した場合は`State=2`とします。
3.  **トークン生成**: ルームとトークンを生成します。
4. **データを保存**: ルームとトークンに関するデータを、`rooms_list`と`token_list`に保存します。
5.  **TCPレスポンス**: `State=2`とともにトークンをクライアントに送信します。

#### クライアント
1.  **クライアント起動**: `client.py` を実行すると、クライアントが起動します。
2.  **ユーザー入力**: ユーザー名と操作コード（1: 作成 or 2: 参加）を入力します。
3.  **TCP接続**: TCPサーバーに接続をリクエストし、サーバーはこれを許可します。
4.  **ルーム情報入力**: ルーム名とパスワードを入力します。
5.  **TCPリクエスト**: `State=0`でTCPリクエストをサーバーに送信します。
6. **TCPレスポンス受信**: サーバーから`State=2`とともにトークンを受信します。
6. **TCP切断**: クライアントはトークンを保持し、TCP接続を解除します。

### UDP通信

#### サーバー
1.  **メッセージ受信待機**: サーバーはクライアントからのメッセージの受信の待機状態に入ります。
2. **メッセージ受信・検証**: サーバーはUDPパケットを受信し、検証を行います。
3. **メッセージ中継**: クライアントが入っているルームの他のクライアントにメッセージを送信します。


#### クライアント
1. **メッセージ送信**: クライアントはUDPパケット（ルーム名、トークン、ユーザー名、メッセージ）をサーバーに送信します。
2. **メッセージ送信**: 同じルーム内他のクライアントからのメッセージを受信します。

## タイムアウト・退出処理

サーバーはクライアントの活動を監視し、非アクティブなクライアントや退出したクライアントを管理します。

* **タイムアウト処理**:
    * サーバーは20秒毎に`token_list`をチェックします。
    * 120秒間アクティブでないクライアントは、`rooms_list`と`token_list`から削除されます。
    * タイムアウトしたクライアントには切断メッセージが送信されます。
* **ホストの退出**:
    * ホストが退出（タイムアウト）すると、ルームは自動的に削除されます。
    * ルーム内の全クライアントにルーム閉鎖メッセージが送信され、関連するルーム情報とトークンが削除されます。
    * ホストの退出メッセージを受信したクライアントは、自動的にプログラムが終了します。
* **一般クライアントの退出**:
    * ホストではないクライアントが退出（またはタイムアウト）すると、そのクライアントは`rooms_list`と`token_list`から削除されます。
    * ルーム内の他のメンバーに退出メッセージが送信されます。これを受信したクライアントはそのままチャットを利用できます。

## 実行方法

1.  **サーバーの起動**: チャットシステムを利用する際は、先にサーバーを起動させる必要があります。
    ```bash
    python3 server.py
    ```
2.  **クライアントの起動**: 次にクライアントを起動します。クライアントを追加したい場合は、その都度コンソールを追加して実行します。
    ```bash
    python3 client.py
    ```